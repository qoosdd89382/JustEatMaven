package com.visit.model;

import java.util.*;

import com.announce.model.AnnounceJDBCDAO;
import com.announce.model.AnnounceVO;

import java.sql.*;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

public class VisitJDBCDAO implements VisitDAOInterface{
	
	private static String driver = "com.mysql.cj.jdbc.Driver";
	private static String url = "jdbc:mysql://localhost:3306/JustEat?serverTimezone=Asia/Taipei";
	private static String userid = "DBAdmin";
	private static String password = "justeat";
	
	private static final String Insert_Stmt = "Insert into Visit "
			+ "(account_id,visit_record)"
			+ "Values(?,?)";

	private static final String Update_Stmt = "Update Visit set "
			+ "account_id=?,visit_record=?"
			+ "Where visit_id=?";
	private static final String Delete_Stmt = 
			"Delete From Visit Where visit_id=?";
	private static final String Select_Key_Stmt = 
			"Select * From JustEat.Visit Where visit_id=?";
	private static final String Select_All_Stmt = 
			"Select * From JustEat.Visit";
	
	//每次登入都給紀錄
	private static final String Insert_VisitRecord_By_AccountID = "Insert into Visit "
			+ "(account_id,visit_record)"
			+ "Values(?,NOW())";
	//取得最新的瀏覽紀錄時間
	private static final String Get_Latest_VisitRecord_By_AccountID = "Select visit_record "
			+ "From JustEat.Visit Where account_id=? Order By visit_record Desc Limit 1";
	//取得上一次的瀏覽紀錄時間
	private static final String Get_Last_VisitRecord_By_AccountID = "Select visit_record "
			+ "From JustEat.Visit Where account_id=? Order By visit_record Desc Limit 1,1";
	//取得間隔的瀏覽時間
	private static final String Get_Period_VisitRecord_By_AccountID = "select TIMEDIFF("
			+ "(SELECT visit_record FROM JustEat.Visit where account_id=? order by visit_record desc limit 1),"
			+ "(SELECT visit_record FROM JustEat.Visit where account_id=? order by visit_record desc limit 1,1)"
			+ ") diff";
	
	static {
		try {
			Class.forName(driver);
		} catch (ClassNotFoundException e) {
			e.printStackTrace(System.err);
		}
	}

	@Override
	public void insert(VisitVO visitVO) {
		Connection con = null;
		PreparedStatement pstmt = null;
		ResultSet rs =null;
		
		String[] autoGeneratedCol = {"visit_id"};
		
		try {
			con = DriverManager.getConnection(url,userid,password);
			pstmt = con.prepareStatement(Insert_Stmt,autoGeneratedCol);
			
			pstmt.setInt(1,visitVO.getAccountID());
			pstmt.setTimestamp(2,visitVO.getVisitRecord());
			
			pstmt.executeUpdate();
			
			rs = pstmt.getGeneratedKeys();
			if(rs.next()) {
				Integer autoGeneratedkey = rs.getInt(1);
				System.out.println("Visit insert completed!Visit_id="+autoGeneratedkey);
			}else {
				System.out.println("Visit insert failed!");
			}
		}catch(Exception e) {
			e.printStackTrace();
		}finally {
			if (rs != null) {
				try {
					rs.close();
				}catch(Exception e) {
					e.printStackTrace(System.err);
				}
			}
			if (pstmt != null) {
				try {					
					pstmt.close();
				}catch (Exception e){
					e.printStackTrace(System.err);
				}
			}
			if (con != null) {
				try {
					con.close();
				}catch(Exception e) {
					e.printStackTrace(System.err);
				}
			}
		}
	}

	@Override
	public void update(VisitVO visitVO) {
		Connection con = null;
		PreparedStatement pstmt = null;
		
		try {
			con = DriverManager.getConnection(url,userid,password);
			pstmt = con.prepareStatement(Update_Stmt);
			
			pstmt.setInt(1,visitVO.getAccountID());
			pstmt.setTimestamp(2,visitVO.getVisitRecord());
			pstmt.setInt(3,visitVO.getVisitID());
			
			pstmt.executeUpdate();
			
		}catch (Exception e){
			e.printStackTrace(System.err);
		}finally {
			if (pstmt != null) {
				try {
					pstmt.close();
				}catch(Exception e) {
					e.printStackTrace(System.err);
				}
			}
			if (con != null) {
				try {
					con.close();
				}catch(Exception e) {
					e.printStackTrace(System.err);;
				}
			}
		}
	}

	@Override
	public void delete(Integer visit_id) {
		Connection con = null;
		PreparedStatement pstmt = null;
		
		try {
			con = DriverManager.getConnection(url, userid, password);
			pstmt = con.prepareStatement(Delete_Stmt);
			pstmt.setInt(1, visit_id);
			pstmt.executeUpdate();

			System.out.println("Visit delete completed!");
		}catch(Exception e){
			e.printStackTrace();
		}finally {
			if (pstmt != null) {
				try {
					pstmt.close();
				} catch (Exception e) {
					e.printStackTrace(System.err);
				}
			}
			if (con != null) {
				try {
					con.close();
				} catch (Exception e) {
					e.printStackTrace(System.err);
				}
			}
		}
	}

	@Override
	public VisitVO findByPrimaryKey(Integer visit_id) {
		Connection con = null;
		PreparedStatement pstmt = null;
		ResultSet rs = null;
		VisitVO visitVO = null;
		
		try {
			con = DriverManager.getConnection(url, userid, password);
			pstmt = con.prepareStatement(Select_Key_Stmt);
			
			pstmt.setInt(1, visit_id);
			rs = pstmt.executeQuery();

			while (rs.next()) {
				visitVO = new VisitVO();
				visitVO.setVisitID(rs.getInt("visit_id"));
				visitVO.setAccountID(rs.getInt("account_id"));
				visitVO.setVisitRecord(rs.getTimestamp("visit_record"));
			}
		} catch(Exception e) {
			e.printStackTrace();
		} finally {
			if(rs != null) {
				try {
					rs.close();					
				}catch(Exception e) {
					e.printStackTrace(System.err);
				}
			}
			if (pstmt != null) {
				try {
					pstmt.close();
				} catch (Exception e) {
					e.printStackTrace(System.err);
				}
			}
			if (con != null) {
				try {
					con.close();
				} catch (Exception e) {
					e.printStackTrace(System.err);
				}
			}
		}
		return visitVO;
	}

	@Override
	public List<VisitVO> getAll() {
		List<VisitVO> list = new ArrayList<VisitVO>();
		VisitVO visitVO = null;
		
		Connection con = null;
		PreparedStatement pstmt = null;
		ResultSet rs = null;
		
		try {
			Class.forName(driver);
			con = DriverManager.getConnection(url, userid, password);
			pstmt = con.prepareStatement(Select_All_Stmt);
			rs = pstmt.executeQuery();
			
			while (rs.next()) {
				visitVO = new VisitVO();
				visitVO.setVisitID(rs.getInt("visit_id"));
				visitVO.setAccountID(rs.getInt("account_id"));
				visitVO.setVisitRecord(rs.getTimestamp("visit_record"));
				list.add(visitVO);
			}
		}catch(Exception e) {
			e.printStackTrace();
		}finally {
			if (rs != null) {
				try {
					rs.close();
				} catch (SQLException se) {
					se.printStackTrace(System.err);
				}
			}
			if (pstmt != null) {
				try {
					pstmt.close();
				} catch (SQLException se) {
					se.printStackTrace(System.err);
				}
			}
			if (con != null) {
				try {
					con.close();
				} catch (Exception e) {
					e.printStackTrace(System.err);
				}
			}
		}
		return list;
	}
	
	@Override
	public void insertVisitRecordByAccountID(Integer accountID) {
		Connection con = null;
		PreparedStatement pstmt = null;
		ResultSet rs =null;
		
		String[] autoGeneratedCol = {"visit_id"};
		
		try {
			con = DriverManager.getConnection(url,userid,password);
			pstmt = con.prepareStatement(Insert_VisitRecord_By_AccountID,autoGeneratedCol);
			
			pstmt.setInt(1,accountID);
			
			pstmt.executeUpdate();
			
			rs = pstmt.getGeneratedKeys();
			if(rs.next()) {
				Integer autoGeneratedkey = rs.getInt(1);
				System.out.println("Visit insert completed!Visit_id="+autoGeneratedkey);
			}else {
				System.out.println("Visit insertByID failed!");
			}
		}catch(Exception e) {
			e.printStackTrace();
		}finally {
			if (rs != null) {
				try {
					rs.close();
				}catch(Exception e) {
					e.printStackTrace(System.err);
				}
			}
			if (pstmt != null) {
				try {					
					pstmt.close();
				}catch (Exception e){
					e.printStackTrace(System.err);
				}
			}
			if (con != null) {
				try {
					con.close();
				}catch(Exception e) {
					e.printStackTrace(System.err);
				}
			}
		}
	}
	
	@Override
	public VisitVO getLatestVisitRecordByAccountID(Integer accountID) {
		Connection con = null;
		PreparedStatement pstmt = null;
		ResultSet rs = null;
		VisitVO visitVO = null;
		
		try {
			con = DriverManager.getConnection(url,userid,password);
			pstmt = con.prepareStatement(Get_Latest_VisitRecord_By_AccountID);
			
			pstmt.setInt(1,accountID);
			
			rs = pstmt.executeQuery();

			while (rs.next()) {
				visitVO = new VisitVO();
				visitVO.setVisitRecord(rs.getTimestamp("visit_record"));
			}
		} catch(Exception e) {
			e.printStackTrace();
		} finally {
			if(rs != null) {
				try {
					rs.close();					
				}catch(Exception e) {
					e.printStackTrace(System.err);
				}
			}
			if (pstmt != null) {
				try {					
					pstmt.close();
				}catch (Exception e){
					e.printStackTrace(System.err);
				}
			}
			if (con != null) {
				try {
					con.close();
				}catch(Exception e) {
					e.printStackTrace(System.err);
				}
			}
		}
		return visitVO;
	}
	
	@Override
	public VisitVO getLastVisitRecordByAccountID(Integer accountID) {
		Connection con = null;
		PreparedStatement pstmt = null;
		ResultSet rs = null;
		VisitVO visitVO = null;
		
		try {
			con = DriverManager.getConnection(url,userid,password);
			pstmt = con.prepareStatement(Get_Last_VisitRecord_By_AccountID);
			
			pstmt.setInt(1,accountID);
			
			rs = pstmt.executeQuery();

			while (rs.next()) {
				visitVO = new VisitVO();
				visitVO.setVisitRecord(rs.getTimestamp("visit_record"));
			}
		} catch(Exception e) {
			e.printStackTrace();
		} finally {
			if(rs != null) {
				try {
					rs.close();					
				}catch(Exception e) {
					e.printStackTrace(System.err);
				}
			}
			if (pstmt != null) {
				try {					
					pstmt.close();
				}catch (Exception e){
					e.printStackTrace(System.err);
				}
			}
			if (con != null) {
				try {
					con.close();
				}catch(Exception e) {
					e.printStackTrace(System.err);
				}
			}
		}
		return visitVO;
	}
	
	
	@Override
	public VisitVO getPeriodVisitRecordByAccountID(Integer accountID) {
		Connection con = null;
		PreparedStatement pstmt = null;
		ResultSet rs = null;
		VisitVO visitVO = null;
		
		try {
			con = DriverManager.getConnection(url,userid,password);
			pstmt = con.prepareStatement(Get_Period_VisitRecord_By_AccountID);
			
			pstmt.setInt(1,accountID);
			pstmt.setInt(2,accountID);
			
			rs = pstmt.executeQuery();

			while (rs.next()) {
				visitVO = new VisitVO();
				visitVO.setVisitRecord(rs.getTimestamp("diff"));
			}
		} catch(Exception e) {
			e.printStackTrace();
		} finally {
			if(rs != null) {
				try {
					rs.close();					
				}catch(Exception e) {
					e.printStackTrace(System.err);
				}
			}
			if (pstmt != null) {
				try {					
					pstmt.close();
				}catch (Exception e){
					e.printStackTrace(System.err);
				}
			}
			if (con != null) {
				try {
					con.close();
				}catch(Exception e) {
					e.printStackTrace(System.err);
				}
			}
		}
		return visitVO;
	}
	public static void main(String[] args) {
		String date = "2021-02-03 14:00";
		DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm");
		LocalDateTime localDateTime = LocalDateTime.parse(date,formatter);
		Timestamp timestampdate = Timestamp.valueOf(localDateTime);
		
		VisitJDBCDAO visitJDBCDAO = new VisitJDBCDAO();
		
		VisitVO visitVO = new VisitVO();
		
		//新增 OK 要先在會員新增
//		visitVO.setAccountID(100001);
//		visitVO.setVisitTime(timestampdate);
//		visitJDBCDAO.insert(visitVO);
		//刪除 OK
//		visitJDBCDAO.delete(900001);

		//瀏覽紀錄不需要修改 
//		visitVO.setAccountID(100001);
//		visitVO.setVisitTime(timestampdate);
//		visitVO.setVisitID(900004);
//		visitJDBCDAO.update(visitVO);
		
		//查詢 OK
//		visitVO = visitJDBCDAO.findByPrimaryKey(900004);
//		System.out.println(visitVO.getAccountID()+",");
//		System.out.println(visitVO.getVisitRecord()+",");
//		System.out.println("search complete!");
		
		//查詢全部 OK
//		List<VisitVO> visitVO_list = visitJDBCDAO.getAll();
//		for (VisitVO e:visitVO_list) {
//			System.out.println(e.getAccountID()+",");
//			System.out.println(e.getVisitRecord()+",");
//		}
		
	}
}
